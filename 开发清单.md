# Excel编辑器插件开发清单

## 项目概述

Excel编辑器插件是一个VS Code扩展，用于在VS Code中编辑Excel文件，提供实时同步和表单编辑功能。通过观察者模式实现编辑器与侧边栏表单之间的双向数据同步，确保用户操作的实时反馈。

## 项目结构

```
excel-plugin/
├── src/
│   ├── ExcelExtension.ts               # 核心扩展逻辑
│   ├── ExcelSidebarProvider.ts         # 侧边栏提供器
│   ├── sync/                           # 同步相关代码
│   │   ├── core/                       # 同步核心
│   │   │   ├── BaseSyncHandler.ts      # 同步处理器基类
│   │   │   ├── SyncCoordinator.ts      # 同步协调器
│   │   │   └── SyncTypes.ts            # 同步类型定义
│   │   ├── handlers/                   # 同步处理器
│   │   ├── SyncConfigManager.ts        # 同步配置管理
│   │   └── SyncManagerV2.ts            # 同步管理器
│   ├── utils/                          # 工具类
│   │   ├── EditorUtils.ts              # 编辑器工具
│   │   ├── HtmlTemplateLoader.ts       # HTML 模板加载器
│   │   └── SmartDebouncer.ts           # 智能抖动系统
│   └── test/                           # 测试文件
├── webview/                            # 前端文件
│   ├── sidebar.html                    # 侧边栏 HTML 模板
│   ├── sidebar-fallback.html           # 备用 HTML 模板
│   ├── sidebar-form.html               # 表单 HTML 模板
│   ├── sidebar.css                     # 侧边栏样式
│   ├── sidebar.js                      # 侧边栏脚本
│   └── smart-debouncer.js              # 智能抖动系统前端
├── media/                              # 媒体资源
├── assets/                             # 媒体资源
├── package.json                        # 项目配置
├── tsconfig.json                       # TypeScript 配置
├── eslint.config.mjs                   # ESLint 配置
├── README.md                           # 项目说明
├── LICENSE                             # 许可证
└── CHANGELOG.md                        # 更新日志
```

## 核心文件说明

### 1. ExcelExtension.ts

**功能**：核心扩展逻辑，处理编辑器事件、数据解析和同步管理。

**主要功能**：
- 激活和停用扩展
- 解析Excel文件内容
- 计算总列数（使用所有行中的最大列数）
- 处理光标变化事件
- 处理编辑器内容变化事件
- 实时同步数据到侧边栏

**关键函数**：
- `activate`：激活扩展，初始化所有组件
- `parseExcelFile`：解析Excel文件内容
- `parseEditorContent`：解析编辑器内容
- `updateCurrentLineData`：更新当前行数据
- `handleCursorChange`：处理光标变化事件
- `handleEditorChange`：处理编辑器内容变化事件

### 2. ExcelSidebarProvider.ts

**功能**：侧边栏提供器，管理WebView通信和消息传递。

**主要功能**：
- 创建和管理WebView
- 发送消息到前端
- 接收前端消息并处理
- 同步数据到侧边栏

**关键函数**：
- `resolveWebviewView`：解析WebView视图
- `postMessage`：发送消息到前端
- `setData`：设置数据并发送到前端
- `selectRow`：选择行并发送数据到前端
- `updateHeaders`：更新表头
- `updateLineStats`：更新行数统计

### 3. sidebar.js

**功能**：前端逻辑，处理表单渲染、数据填充和用户交互。

**主要功能**：
- 初始化前端组件
- 渲染表单
- 填充表单数据
- 处理用户输入
- 发送消息到后端
- 接收后端消息并处理

**关键函数**：
- `handleData`：处理从后端接收的数据
- `renderForm`：渲染表单
- `selectRow`：选择行并填充表单数据
- `updateCell`：更新单元格数据
- `updateUI`：更新UI

### 4. 同步相关文件

#### 4.1 SyncCoordinator.ts

**功能**：同步协调器，实现观察者模式的主题角色，管理事件分发。

**主要功能**：
- 注册和注销同步处理器
- 接收和处理事件
- 分发给符合条件的同步处理器
- 管理事件队列

**关键函数**：
- `registerHandler`：注册同步处理器
- `unregisterHandler`：注销同步处理器
- `emit`：接收事件并加入队列
- `processEventQueue`：处理事件队列
- `processEvent`：将事件分发给同步处理器

#### 4.2 SyncManagerV2.ts

**功能**：同步管理器，管理同步协调器和配置。

**主要功能**：
- 初始化同步协调器
- 注册所有同步处理器
- 触发事件发布
- 刷新同步配置

**关键函数**：
- `registerHandlers`：注册同步处理器
- `emit`：触发事件发布
- `refreshConfig`：刷新同步配置

#### 4.3 同步处理器

**功能**：实现观察者模式的观察者角色，监听并处理特定类型的事件。

**主要处理器**：
- `HeaderToFormSyncHandler`：处理表头到表单的同步
- `CursorRowToCurrentRowInputSyncHandler`：处理光标行到当前行输入的同步
- `CurrentRowInputToCursorSyncHandler`：处理当前行输入到光标的同步
- `EditorToFormSyncHandler_LessThan`：处理编辑器到表单的小于条件同步
- `EditorToFormSyncHandler_Equal`：处理编辑器到表单的等于条件同步
- `EditorToFormSyncHandler_GreaterThan`：处理编辑器到表单的大于条件同步
- `FormToHeaderSyncHandler`：处理表单到表头的同步

**关键方法**：
- `canHandle`：判断是否能处理特定事件
- `handle`：处理事件的具体逻辑
- `dispose`：清理资源

## 数据流程

### 1. 激活插件

1. 用户激活插件
2. 插件初始化所有组件
3. 监听编辑器事件

### 2. 编辑器中显示Excel文件

1. 用户在VS Code中打开Excel文件
2. 插件检测到Excel文件并开始处理

### 3. 初始化渲染Excel文件基础信息

1. 插件解析Excel文件内容
2. 计算总列数（使用所有行中的最大列数）
3. 计算总行数
4. 发送文件基础信息到前端

### 4. 开始实时同步

1. 插件开始监听编辑器事件
2. 前端开始监听后端消息

### 5. 插件中渲染表单

1. 前端接收到文件基础信息
2. 前端渲染表单结构

### 6. 初始化总列数

1. 插件计算Excel文件中所有行的最大列数
2. 发送总列数到前端
3. 前端根据总列数渲染表单项

### 7. 初始化表头行的值

1. 插件使用默认值（第1行）或之前保存的值作为表头行
2. 确保表头行值不大于总行数
3. 发送表头行值到前端

### 8. 初始化当前行的值

1. 插件获取光标所在行作为当前行
2. 发送当前行值到前端
3. 前端更新当前行输入框

### 9. 初始化表单项名称

1. 前端根据表头行值获取编辑器对应行的数据
2. 渲染表单项名称（表头名称）
3. 如果表单项数量小于总列数，补充默认列名

### 10. 初始化表单项的值

1. 前端根据当前行值获取编辑器对应行的数据
2. 渲染表单项的值
3. 直接从上往下填充数据，不根据表单项名称对应

### 11. 开始编辑表单

1. 用户在表单中输入数据
2. 前端监听输入事件
3. 发送编辑数据到后端
4. 后端更新编辑器内容

### 12. 开始编辑编辑器光标所在行数据

1. 用户在编辑器中编辑数据
2. 后端监听编辑器内容变化事件
3. 发送编辑数据到前端
4. 前端更新表单数据

### 13. 开始切换光标所在行

1. 用户在编辑器中切换光标位置
2. 后端监听光标变化事件
3. 发送新光标位置到前端
4. 前端更新当前行值和表单项数据

## 观察者模式分析

### 核心组件与角色

#### 1. 主题（Subject）角色
- **SyncCoordinator** (`src/sync/core/SyncCoordinator.ts`)：作为核心协调器，维护观察者列表并分发事件

#### 2. 观察者（Observer）角色
- **SyncHandler** 接口 (`src/sync/core/SyncTypes.ts`)：定义观察者的基本行为
- 具体实现类：
  - `HeaderToFormSyncHandler`
  - `CursorRowToCurrentRowInputSyncHandler`
  - `CurrentRowInputToCursorSyncHandler`
  - `EditorToFormSyncHandler_LessThan`
  - `EditorToFormSyncHandler_Equal`
  - `EditorToFormSyncHandler_GreaterThan`
  - `FormToHeaderSyncHandler`

#### 3. 事件源（Event Source）
- **产生事件的组件**：
  - VS Code 编辑器（文本变更、光标移动）
  - 侧边栏表单（表单输入、当前行输入框变更）
  - 系统内部状态变化

### 实现机制

#### 1. 观察者注册与管理
- `SyncCoordinator.registerHandler()`：注册观察者到内部Map中
- `SyncCoordinator.unregisterHandler()`：从Map中移除观察者
- `SyncCoordinator.getAllHandlers()`：获取所有注册的观察者

#### 2. 事件发布与分发
- `SyncManagerV2.emit()`：触发事件发布
- `SyncCoordinator.emit()`：接收事件并加入队列
- `SyncCoordinator.processEventQueue()`：处理事件队列
- `SyncCoordinator.processEvent()`：将事件分发给符合条件的观察者

#### 3. 事件类型系统
- 定义了多种事件类型：
  - `HeaderChangeEvent`
  - `EditorChangeEvent`
  - `FormChangeEvent`
  - `CursorRowChangeEvent`
  - `CurrentRowInputChangeEvent`
  - `CurrentRowInputToCursorEvent`

#### 4. 观察者行为定义
- 每个观察者实现 `SyncHandler` 接口的方法：
  - `canHandle()`：判断是否能处理特定事件
  - `handle()`：处理事件的具体逻辑
  - `dispose()`：清理资源

### 工作流程

1. **初始化阶段**：
   - `SyncManagerV2` 构造函数创建 `SyncCoordinator` 实例
   - 调用 `registerHandlers()` 注册所有具体观察者

2. **事件触发阶段**：
   - 外部通过 `SyncManagerV2.emit()` 触发事件
   - 事件被加入 `SyncCoordinator` 的事件队列

3. **事件处理阶段**：
   - `SyncCoordinator` 处理事件队列
   - 对每个事件，筛选出符合条件的观察者（enabled 且 canHandle 返回 true）
   - 按优先级顺序调用观察者的 `handle()` 方法

4. **配置管理**：
   - `SyncConfigManager` 管理观察者的启用状态
   - 通过 `refreshConfig()` 方法根据配置更新观察者状态

### 具体操作示例

#### 1. 编辑器光标移动
**操作**：用户在 VS Code 编辑器中移动光标到不同行  
**事件流程**：
- 事件源（编辑器）触发 `cursorRowChange` 事件
- `SyncManagerV2.emit()` 将事件传递给 `SyncCoordinator`
- `SyncCoordinator` 处理事件，筛选符合条件的观察者
- `CursorRowToCurrentRowInputSyncHandler`（观察者）的 `canHandle()` 返回 true
- 调用该观察者的 `handle()` 方法，更新侧边栏的当前行输入框值

#### 2. 侧边栏当前行输入框变更
**操作**：用户在侧边栏的当前行输入框中输入新值  
**事件流程**：
- 事件源（侧边栏表单）触发 `currentRowInputChange` 事件
- `SyncManagerV2.emit()` 将事件传递给 `SyncCoordinator`
- `SyncCoordinator` 处理事件，筛选符合条件的观察者
- `CurrentRowInputToCursorSyncHandler`（观察者）的 `canHandle()` 返回 true
- 调用该观察者的 `handle()` 方法，将编辑器光标移动到对应行

#### 3. 编辑器内容变更
**操作**：用户在 VS Code 编辑器中修改单元格内容  
**事件流程**：
- 事件源（编辑器）触发 `editorChange` 事件
- `SyncManagerV2.emit()` 将事件传递给 `SyncCoordinator`
- `SyncCoordinator` 处理事件，筛选符合条件的观察者
- 多个观察者（如 `EditorToFormSyncHandler_LessThan`、`EditorToFormSyncHandler_Equal` 等）的 `canHandle()` 返回 true
- 按优先级顺序调用这些观察者的 `handle()` 方法，更新侧边栏表单中对应条件的字段值

#### 4. 表头变更
**操作**：用户修改 Excel 表格的表头行  
**事件流程**：
- 事件源（编辑器）触发 `headerChange` 事件
- `SyncManagerV2.emit()` 将事件传递给 `SyncCoordinator`
- `SyncCoordinator` 处理事件，筛选符合条件的观察者
- `HeaderToFormSyncHandler`（观察者）的 `canHandle()` 返回 true
- 调用该观察者的 `handle()` 方法，更新侧边栏表单的表头显示

#### 5. 表单字段输入
**操作**：用户在侧边栏表单中输入字段值  
**事件流程**：
- 事件源（侧边栏表单）触发 `formChange` 事件
- `SyncManagerV2.emit()` 将事件传递给 `SyncCoordinator`
- `SyncCoordinator` 处理事件，筛选符合条件的观察者
- `FormToHeaderSyncHandler`（观察者）的 `canHandle()` 返回 true
- 调用该观察者的 `handle()` 方法，更新编辑器中对应单元格的值

## 功能实现

### 1. 总列数计算

**实现**：在`parseExcelFile`和`parseEditorContent`函数中，遍历所有行，计算每行的列数，取最大值作为总列数。

### 2. 表头行初始化

**实现**：默认使用第1行作为表头行，如果之前有保存的值则使用之前的值，确保表头行值不大于总行数。

### 3. 当前行初始化

**实现**：使用光标所在行作为当前行，发送到前端后更新前端的当前行输入框。

### 4. 表单项名称渲染

**实现**：根据表头行值获取编辑器对应行的数据，渲染表单项名称（表头名称），如果表单项数量小于总列数，补充默认列名。

### 5. 表单项值渲染

**实现**：根据当前行值获取编辑器对应行的数据，直接从上往下填充数据到表单项，不根据表单项名称对应。

### 6. 实时同步

**实现**：使用观察者模式和事件监听器，实现编辑器和表单之间的实时同步。通过 `SyncCoordinator` 分发事件，各同步处理器根据事件类型执行相应的同步逻辑。

## 维护说明

### 1. 代码规范

- 使用TypeScript编写后端代码
- 使用ES6+编写前端代码
- 遵循VS Code扩展开发规范
- 保持代码风格一致

### 2. 调试方法

- 使用VS Code的扩展开发模式调试
- 在前端代码中使用`console.log`打印调试信息
- 在后端代码中使用`console.log`打印调试信息
- 使用VS Code的调试工具查看变量和调用栈

### 3. 常见问题及解决方案

**问题**：表单数据不显示

**解决方案**：
- 检查数据是否正确发送到前端
- 检查前端是否正确处理数据
- 检查表单项是否正确渲染
- 检查数据填充逻辑是否正确

**问题**：总列数计算错误

**解决方案**：
- 检查`parseExcelFile`和`parseEditorContent`函数中的总列数计算逻辑
- 确保遍历所有行计算列数

**问题**：实时同步不工作

**解决方案**：
- 检查事件监听器是否正确注册
- 检查消息传递是否正确
- 检查同步逻辑是否正确
- 检查观察者是否正确注册到`SyncCoordinator`

### 4. 扩展功能

**可能的扩展功能**：

- 支持更多Excel文件格式
- 增加数据验证功能
- 增加数据筛选功能
- 增加插入行功能
- 增加当前正在编辑表单项输入框时候，编辑器内高亮显示编辑内容
- 增加设置项可以控制插件的功能

## 版本控制

- 使用Git进行版本控制
- 定期提交代码
- 编写清晰的提交信息
- 遵循语义化版本规范

## 发布流程

1. 测试扩展功能
2. 更新package.json中的版本号
3. 构建扩展
4. 发布到VS Code扩展市场

## 结论

Excel编辑器插件是一个功能强大的VS Code扩展，提供了在VS Code中编辑Excel文件的能力。通过观察者模式实现的实时同步机制，确保了编辑器与侧边栏表单之间的数据一致性，提升了用户的编辑体验。

本开发清单提供了项目的结构、功能和实现细节，便于后续维护和扩展。